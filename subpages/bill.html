<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Invoice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans Devanagari', 'Mangal', 'Helvetica Neue', Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        .invoice-container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 3px solid #d00000;
        }
        .logo img {
            width: 190px;
            height: auto;
        }
        .hospital-name {
            color: red;
            font-size: 32px;
            font-weight: bold;
            font-family: 'Mangal', sans-serif;
            margin-left: 20px;
        }
        .sub-heading {
            text-align: center;
            font-size: 18px;
            color: #333;
            margin-top: 10px;
        }
        .date-container {
            margin-bottom: 20px;
        }
        input[type="text"] {
            padding: 5px;
            font-size: 16px;
            width: 100px;
        }
        .doctor-info {
            text-align: right;
            font-size: 14px;
        }
        .doctor-info p {
            margin: 5px 0;
        }
        .doctor-info .name {
            font-weight: bold;
            color: red;
        }
        .invoice-details {
            margin: 20px 0;
            width: 650px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: start;
            vertical-align: middle;
        }
        table th {
            background: #e0d6c9;
            text-align: center;
        }
        /* Set width for PRICE (‚Çπ) column */
        #invoiceTable th:nth-child(3),
        #invoiceTable td:nth-child(3) {
            width: 150px;
            text-align: center;
        }
        .total {
            text-align: right;
            font-weight: bold;
            margin-top: 10px;
            font-size: 18px;
            margin-right: 100px;
        }
        .footer {
            margin-top: 30px;
            text-align: left;
            font-size: 14px;
            color: #d32f2f;
        }
        .signature {
            margin-top: 30px;
            text-align: right;
            font-style: italic;
        }
        .buttons {
            margin-top: 20px;
            text-align: center;
        }
        .buttons button {
            padding: 10px 20px;
            font-size: 16px;
            background: #d32f2f;
            color: #fff;
            border: none;
            cursor: pointer;
            margin: 0 10px;
            border-radius: 5px;
        }
        .buttons button:hover {
            background: #b71c1c;
        }
        .rupee-input {
            width: 120px;
            padding: 5px;
            padding-left: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
            font-size: 14px;
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f8f8;
            padding: 5px 10px;
        }
        .navbar img {
            height: 50px;
            margin-left: 20px;
        }
        .navbar .buttons {
            display: flex;
            gap: 10px;
        }
        .navbar .buttons button {
            padding: 8px 16px;
            font-size: 14px;
            background: #d32f2f;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        .label {
            font-weight: bold;
            min-width: 150px;
            text-align: right;
        }
        .value {
            min-width: 200px;
            padding-left: 10px;
        }
        #dateInput {
            width: 150px;
            padding: 5px;
        }
        .letterhead {
            border-bottom: 2px solid #070a0d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        .hospital-logo {
            width: 160px;
            height: 110px;
        }
        .hospital-info {
            text-align: right;
        }
        .hospital-name {
            font-family: 'Helvetica Neue', sans-serif;
            font-weight: 700;
            color: red;
            font-size: 32px;
            letter-spacing: 1.5px;
        }
        .hospital-address {
            font-size: 18px;
            color: #666;
        }
        .doctor-name-left,
        .doctor-name-right {
            position: absolute;
            top: 0;
            font-family: 'Helvetica Neue', sans-serif;
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .doctor-name-left {
            left: 0;
        }
        .doctor-name-right {
            right: 0;
        }
        .add-row-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        .add-row-btn:hover {
            background-color: #45a049;
        }
        .delete-row-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }
        .delete-row-btn:hover {
            background-color: #d32f2f;
        }
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: #fff;
            }
            @page {
                size: A4;
                margin: 4mm;
            }
            .invoice-container {
                box-shadow: none;
                border-radius: 0;
                width: 100%;
                max-width: 100%;
                padding: 10px;
            }
            .buttons, .navbar, .hr, .add-row-btn, .delete-row-btn {
                display: none;
            }
            .rupee-input, #dateInput, #invoiceTable input[type="text"] {
                display: none;
            }
            #invoiceTable td:nth-child(2)::after,
            #invoiceTable td:nth-child(3)::after {
                content: attr(data-value);
                position: static;
                font-size: 16px;
                color: #000;
            }
            #invoiceTable td:nth-child(3)::after {
                font-size: 18px;
                font-weight: normal;
            }
            #invoiceTable .total::after {
                content: attr(data-value);
                font-size: 18px;
                font-weight: bold;
            }
            #currentDate::after {
                content: attr(data-value);
                font-size: 14px;
                margin-left: 10px;
            }
            .invoice-details span,
            .hospital-name span,
            .doctors-info strong,
            .total {
                color: #000;
            }
            .signature::before {
                content: "_______________";
                display: block;
                margin-bottom: 10px;
                margin-top: 50px;
            }
            /* Hide the ACTION column (4th column) in print view */
            #invoiceTable th:nth-child(4),
            #invoiceTable td:nth-child(4) {
                display: none;
            }
            /* Ensure PRICE (‚Çπ) column width in print view */
            #invoiceTable th:nth-child(3),
            #invoiceTable td:nth-child(3) {
                width: 150px;
                text-align: center;
            }
            /* Hide rows where PRICE (‚Çπ) is ‚Çπ 0 or empty */
            #invoiceTable tr td:nth-child(3)[data-value="‚Çπ 0"],
            #invoiceTable tr td:nth-child(3)[data-value="‚Çπ "],
            #invoiceTable tr td:nth-child(3)[data-value="‚Çπ"] {
                display: none;
            }
            #invoiceTable tr:has(td:nth-child(3)[data-value="‚Çπ 0"]),
            #invoiceTable tr:has(td:nth-child(3)[data-value="‚Çπ "]),
            #invoiceTable tr:has(td:nth-child(3)[data-value="‚Çπ"]) {
                display: none;
            }
            /* Ensure the total row is always visible */
            #invoiceTable tr:last-child {
                display: table-row !important;
            }

            @media print {
    /* Hide the actual input elements */
    .rupee-input, #dateInput, #invoiceTable input[type="text"] {
        display: none !important;
    }
    
    /* Show only the data-value content */
    #invoiceTable td:nth-child(3)::after {
        content: attr(data-value);
        font-size: 16px;
    }
    
    /* Special handling for total amount to prevent duplication */
    .total::after {
        content: attr(data-value) !important;
        display: inline !important;
    }
    
    /* Remove any duplicate content */
    .total {
        visibility: visible !important;
    }
    .total span, .total div {
        display: none !important;
    }
}
        }

        @media print {
    .total {
        visibility: hidden;
        position: relative;
    }
    .total::after {
        content: attr(data-value);
        visibility: visible;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 18px;
        font-weight: bold;
    }
}


@media print {
    /* Hide the actual cell content */
    #invoiceTable td:nth-child(2) {
        visibility: hidden;
        position: relative;
    }
    
    /* Show only the data-value content */
    #invoiceTable td:nth-child(2)::after {
        content: attr(data-value);
        visibility: visible;
        position: absolute;
        left: 10px; /* Adjust as needed */
        top: 10px; /* Adjust as needed */
        width: calc(100% - 20px); /* Adjust padding */
    }
    
    /* For PRICE column */
    #invoiceTable td:nth-child(3) {
        visibility: hidden;
        position: relative;
    }
    
    #invoiceTable td:nth-child(3)::after {
        content: attr(data-value);
        visibility: visible;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }
    
    /* For TOTAL row */
    .total {
        visibility: hidden;
        position: relative;
    }
    
    .total::after {
        content: attr(data-value);
        visibility: visible;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }
    
    /* Ensure inputs are hidden */
    .rupee-input, #dateInput, #invoiceTable input[type="text"] {
        display: none !important;
    }
}
        
    </style>
</head>
<body>
    <nav class="navbar" style="height: 50px;">
        <div style="display: flex; align-items: center;"></div>
        <div class="buttons" style="margin-bottom: 10px;">
            <button onclick="window.location.href='./main.html';">üè† Home</button>
            <button onclick="printInvoice()" id="printInvoice">üñ®Ô∏è Print Invoice</button>
        </div>
    </nav>
    <hr class="hr">
    <div class="invoice-container">
        <div class="letterhead">
            <div class="doctor-name-left" style="margin-top: 78px;">
                Dr. Alvin R. Rane.<br> M.S. (Netrarog)<br>
            </div>
            <div style="margin-left: 140px;">
                <img src="../assets/images/Ravikalp_Hospital__new_logo-removebg-preview.png" alt="Hospital Logo" class="hospital-logo">
            </div>
            <div class="hospital-info" style="margin-right: 28%; margin-bottom: 10px;">
                <div class="hospital-name">‡§∞‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§π‡•â‡§∏‡•ç‡§™‡§ø‡§ü‡§≤</div>
                <div class="hospital-address" style="margin-right: 0px;">EYE & GENERAL HOSPITAL<br>PHACO & LASER CENTER</div>
            </div>
            <div class="doctor-name-right" style="margin-top: 78px;">
                Dr. Selina A. Rane <br> M.D. (Ayu)<br>
            </div>
        </div>
        <div class="address-section" style="font-weight: bold;">
            <p class="hospital-address-details">
                <i class="fa-solid fa-location-dot" style="font-size: 20px; width: 24px; height: 25px; margin-left: 30px; color: red;"></i> 518/1/6,Near Panchamukhi Hanuman Mandir Colony Road, Jalgaon | Phone: +91 9423902084
            </p>
            <hr style="border: 1px solid #070a0d;">
        </div>
        <div class="invoice-details">
            <div class="row">
                <span class="label">Patient ID:</span>
                <span class="value" id="patient-id">123456</span>
                <span class="label">Date:</span>
                <span id="currentDate" data-value="">
                    <input type="text" id="dateInput" placeholder="DD/MM/YYYY" onchange="updateDate()">
                </span>
            </div>
            <div class="row" style="margin-left: 20px;">
                <span class="label">Patient Name:</span>
                <span class="value" id="patient-name">John Doe</span>
                <span class="label" style="margin-left: 50px;">Mobile No:</span>
                <span class="value" id="patient-mobile">+1234567890</span>
            </div>
        </div>
        <hr style="border: 1px solid #070a0d;">
        <table id="invoiceTable" style="width: 630px; margin-left: 80px; border: 2px solid black; border-collapse: collapse; text-align: left;">
    <thead>
        <tr style="border: 2px solid black; background-color: #f2f2f2;">
            <th style="border: 2px solid black; padding: 10px;">NO</th>
            <th style="border: 2px solid black; padding: 10px;">PARTICULAR</th>
            <th style="border: 2px solid black; padding: 10px;">PRICE (‚Çπ)</th>
            <th style="border: 2px solid black; padding: 10px;">ACTION</th>
        </tr>
    </thead>
    <tbody>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="1">1</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Consultation">Consultation</td>
            <td style="border: 2px solid black; padding: 10px; text-align: center;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="2">2</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Follow Up">Follow Up</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="3">3</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Stay Charges">Stay Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="4">4</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Nursing Charges">Nursing Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="5">5</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Surgeon Charges">Surgeon Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="6">6</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Anesthesia Charges">Anesthesia Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="7">7</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Operation Theatre Charges">Operation Theatre Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="8">8</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Visiting DR. Charges">Visiting DR. Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="9">9</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Pathology Charges">Pathology Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="10">10</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Visit Charges">Visit Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="11">11</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="I.O.L. Charges">I.O.L. Charges</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;" data-value="12">12</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="Other Charges/Medical/A-scan">Other Charges/Medical/A-scan</td>
            <td style="border: 2px solid black; padding: 10px;" data-value="‚Çπ 0">
                <input type="text" class="rupee-input" value="‚Çπ 0" oninput="calculateTotal(this)">
            </td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
        <tr style="border: 2px solid black;">
            <td style="border: 2px solid black; padding: 10px;"></td>
            <td style="border: 2px solid black; padding: 10px;">Total Amount</td>
            <td style="border: 2px solid black; padding: 10px; text-align: center;" class="total" data-value="‚Çπ 0"></td>
            <td style="border: 2px solid black; padding: 10px;"></td>
        </tr>
    </tbody>
</table>
        <button class="add-row-btn" onclick="addNewRow()">+ Add New Item</button>
        <div class="footer" style="color: black;">
            <div class="signature" style="margin-right: 90px;">
                <p>Dr. Alvin R Rane</p>
            </div>
        </div>
    </div>
  <script>
  // Retrieve the appointment object from localStorage
const appointment = JSON.parse(window.localStorage.getItem("appointment")) || {};
document.getElementById("patient-id").textContent = appointment.id || "N/A";
document.getElementById("patient-name").textContent = appointment.Name || "N/A";
document.getElementById("patient-mobile").textContent = appointment.MobileNo || "N/A";

// Set current date with the format DD/MM/YYYY
function setCurrentDate() {
    const dateInput = document.getElementById('dateInput');
    const currentDate = new Date().toLocaleDateString('en-IN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
    dateInput.value = currentDate;
    document.getElementById('currentDate').dataset.value = currentDate;
}

// Function to update the date based on the input field
function updateDate() {
    const dateInput = document.getElementById('dateInput');
    const selectedDate = dateInput.value;
    const datePattern = /^\d{2}\/\d{2}\/\d{4}$/;
    if (datePattern.test(selectedDate)) {
        document.getElementById('currentDate').dataset.value = selectedDate;
    } else {
        window.electronAPI?.showErrorBox("Error", "Invalid date format. Please use DD/MM/YYYY.");
        setCurrentDate();
    }
}

// Set the current date on page load
setCurrentDate();

// Function to add a new row to the invoice table
function addNewRow() {
    const table = document.getElementById('invoiceTable');
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    const lastRow = rows[rows.length - 2]; // Row before the total row
    const newRowNum = parseInt(lastRow.cells[0].textContent) + 1;

    // Get all existing item descriptions
    const existingItems = Array.from(tbody.querySelectorAll('tr td:nth-child(2) input, tr td:nth-child(2)'))
        .map(td => td.querySelector('input')?.value || td.textContent)
        .filter(item => item && item !== 'Total Amount');

    // Create new row
    const newRow = document.createElement('tr');
    newRow.style.border = '2px solid black';

    // Cell 1: Row number
    const cell1 = document.createElement('td');
    cell1.style.border = '2px solid black';
    cell1.style.padding = '10px';
    cell1.textContent = newRowNum;
    cell1.dataset.value = newRowNum; // Set data-value for print

    // Cell 2: Item description
    const cell2 = document.createElement('td');
    cell2.style.border = '2px solid black';
    cell2.style.padding = '10px';
    const itemInput = document.createElement('input');
    itemInput.type = 'text';
    itemInput.style.width = '100%';
    itemInput.style.border = '1px solid #ddd';
    itemInput.style.padding = '5px';
    itemInput.placeholder = 'Enter item description';
    itemInput.onblur = function() {
        const value = itemInput.value.trim();
        if (value && existingItems.includes(value)) {
            window.electronAPI?.showErrorBox("Error", "This item already exists in the invoice.");
            itemInput.value = '';
            cell2.dataset.value = '';
        } else {
            cell2.dataset.value = value || '';
        }
    };
    cell2.appendChild(itemInput);
    cell2.dataset.value = ''; // Initialize data-value

    // Cell 3: Price
    const cell3 = document.createElement('td');
    cell3.style.border = '2px solid black';
    cell3.style.padding = '10px';
    cell3.style.textAlign = 'center';
    const priceInput = document.createElement('input');
    priceInput.type = 'text';
    priceInput.className = 'rupee-input';
    priceInput.value = '‚Çπ 0';
    priceInput.oninput = function() { calculateTotal(this); };
    cell3.appendChild(priceInput);
    cell3.dataset.value = '‚Çπ 0'; // Initialize data-value

    // Cell 4: Delete button
    const cell4 = document.createElement('td');
    cell4.style.border = '2px solid black';
    cell4.style.padding = '10px';
    cell4.style.textAlign = 'center';
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-row-btn';
    deleteBtn.innerHTML = 'Delete';
    deleteBtn.onclick = function() { deleteRow(this); };
    cell4.appendChild(deleteBtn);

    // Append cells to the new row
    newRow.appendChild(cell1);
    newRow.appendChild(cell2);
    newRow.appendChild(cell3);
    newRow.appendChild(cell4);

    // Insert the new row before the total row
    tbody.insertBefore(newRow, rows[rows.length - 1]);

    // Initialize the new input fields
    initializeInputFields();
}

// Function to delete a row
function deleteRow(button) {
    const row = button.closest('tr');
    row.remove();

    // Re-number the rows
    const table = document.getElementById('invoiceTable');
    const rows = table.querySelectorAll('tbody tr');
    for (let i = 0; i < rows.length - 1; i++) {
        rows[i].cells[0].textContent = i + 1;
        rows[i].cells[0].dataset.value = i + 1; // Update data-value
    }

    // Recalculate the total
    calculateTotal();
}

// Function to initialize input fields
function initializeInputFields() {
    const inputs = document.querySelectorAll('#invoiceTable tbody input[type="text"]');
    inputs.forEach(input => {
        if (input.classList.contains('rupee-input')) {
            input.addEventListener('focus', () => {
                if (input.value === '‚Çπ 0') {
                    input.value = '‚Çπ ';
                }
            });
            input.addEventListener('blur', () => {
                if (input.value === '‚Çπ ' || input.value === '‚Çπ') {
                    input.value = '‚Çπ 0';
                    input.parentElement.dataset.value = '‚Çπ 0';
                } else {
                    input.parentElement.dataset.value = input.value;
                }
            });
            input.addEventListener('input', () => {
                input.parentElement.dataset.value = input.value;
            });
            input.parentElement.dataset.value = input.value;
        } else {
            input.addEventListener('blur', () => {
                input.parentElement.dataset.value = input.value;
            });
            input.parentElement.dataset.value = input.value;
        }
    });

    // Initialize data-value for NO and PARTICULAR columns
    const rows = document.querySelectorAll('#invoiceTable tbody tr');
    rows.forEach((row, index) => {
        if (index < rows.length - 1) { // Exclude total row
            const noCell = row.cells[0];
            const particularCell = row.cells[1];
            noCell.dataset.value = noCell.textContent;
            particularCell.dataset.value = particularCell.querySelector('input')?.value || particularCell.textContent;
        }
    });

    // Calculate initial total
    calculateTotal();
}

// Function to calculate total and format input
function calculateTotal(input) {
    if (input) {
        let value = input.value.replace(/[^\d]/g, '');
        if (value === '') {
            input.value = '‚Çπ ';
            input.parentElement.dataset.value = '‚Çπ 0';
        } else {
            input.value = '‚Çπ ' + parseFloat(value).toLocaleString('en-IN');
            input.parentElement.dataset.value = input.value;
        }
    }

    let total = 0;
    const inputs = document.querySelectorAll("#invoiceTable tbody input[type='text'].rupee-input");
    inputs.forEach(inp => {
        const numValue = parseFloat(inp.value.replace(/[^\d]/g, '')) || 0;
        total += numValue;
    });

    const totalElement = document.querySelector(".total");
    const formattedTotal = total.toLocaleString('en-IN');
    totalElement.dataset.value = `‚Çπ ${formattedTotal}`;
    totalElement.textContent = `‚Çπ ${formattedTotal}`; // Set text content for display
}

// Function to print the invoice
function printInvoice() {
    // Disable printInvoice buttons to prevent multiple clicks
    const printButton = document.getElementById('printInvoice');
    printButton.disabled = true;
    printButton.textContent = '‚è≥ Processing...';
    // Update all data-values and fix numbering
    const rows = document.querySelectorAll("#invoiceTable tbody tr");
    let visibleRowCount = 0;

    // Process all rows except the total row
    for (let i = 0; i < rows.length - 1; i++) {
        const row = rows[i];
        const priceCell = row.cells[2];
        const priceInput = priceCell.querySelector('input');
        const noCell = row.cells[0];
        const particularCell = row.cells[1];

        // Update data-values
        priceCell.dataset.value = priceInput.value;
        particularCell.dataset.value = particularCell.querySelector('input')?.value || particularCell.textContent;

        // Update the NO column only for visible rows
        if (priceInput && 
            priceInput.value !== '‚Çπ 0' && 
            priceInput.value !== '‚Çπ ' && 
            priceInput.value !== '‚Çπ') {
            visibleRowCount++;
            noCell.textContent = visibleRowCount;
            noCell.dataset.value = visibleRowCount;
        } else {
            noCell.dataset.value = '';
        }
    }

    // Recalculate total before printing
    calculateTotal();

    // Ensure total element is correctly set for print
    const totalElement = document.querySelector(".total");
    totalElement.textContent = ''; // Clear text content to avoid duplication in print
    totalElement.dataset.value = totalElement.dataset.value || '‚Çπ 0';

    // Prepare print metadata
    // const tempDateStr = localStorage.getItem("tempDate");
    // const patientId = "P" + (appointment.id || "N/A");
    // let today;
    // if (tempDateStr) {
    //     today = new Date(...tempDateStr.split("/").reverse().map((v, i) => (i === 1 ? v - 1 : +v)));
    // } else {
    //     today = new Date();
    // }
    // const date = today.toLocaleDateString("en-GB").replace(/\//g, "-");
    // const Docname = patientId + "_Bill_" + date;

    // get Date from input field
    const dateInput = document.getElementById('dateInput');
    const tempDateStr = dateInput.value;
    const patientId = "P" + (appointment.id || "N/A");
    console.log("tempDateStr:", tempDateStr);
    let today;
    if (tempDateStr) {
        today = new Date(...tempDateStr.split("/").reverse().map((v, i) => (i === 1 ? v - 1 : +v)));
    } else {
        today = new Date();
    }
    const date = today.toLocaleDateString("en-GB").replace(/\//g, "-");
    const Docname = patientId + "_Bill_" + date;
    console.log("Docname:", Docname);

    // Trigger print
    if (window.electronAPI && window.electronAPI.printPage) {
        saveRecordToFirebase(appointment.id, appointment.Name, date)
        .then(() => {
            // Only runs if save is successful
            window.electronAPI.printPage(patientId, date, Docname);
        })
        .catch((error) => {
            console.error('Error saving record to Firebase:', error);
            window.electronAPI.showErrorBox("Error", "Failed to save the record. Please try again."+" "+ error.message);
        })
        .finally(() => {
            // Always re-enable the button and reset text
            printButton.disabled = false;
            printButton.textContent = 'üñ®Ô∏è Print Invoice';
        });
    } else {
        let printContents = document.querySelector('.invoice-container').innerHTML;
        let originalContents = document.body.innerHTML;
        document.body.innerHTML = printContents;
        window.print();
        document.body.innerHTML = originalContents;
        location.reload();
    }
}

// Initialize input fields on page load
initializeInputFields();
  </script>


<script type="module">
// Your module script
  import { db, collection, addDoc, getDocs, query, orderBy, limit, setDoc, doc, where, getDoc } from "../backend/firebaseConfig.js";

  console.log("Firebase initialized");

 async function saveRecordToFirebase(patientId, patientName, formattedDate) {
    const totalElement = document.querySelector(".total");
    const totalAmount = totalElement?.dataset?.value || "‚Çπ 0";

    // Convert date from DD/MM/YYYY to DDMMYYYY
    const dateCleaned = formattedDate.replace(/\D/g, ''); // removes all non-digit characters
    const customDocId = "B" + patientId + dateCleaned; // e.g., BA000116062025

    // Save to Firestore with custom doc ID
    await setDoc(doc(db, "billsRecords", customDocId), {
      patient_id: patientId,
      patient_name: patientName,
      date: formattedDate,
      bill_amount: totalAmount
    });

    console.log("Bill saved with ID:", customDocId);
  
}

  // Expose to global scope
  window.saveRecordToFirebase = saveRecordToFirebase;
</script>


</body>
</html>